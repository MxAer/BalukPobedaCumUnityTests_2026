test_name: DSL Runtime Evaluation

marks:
  - usefixtures:
      - admin_token
      - user_token
      - user_id
      - generate_random_email

stages:
  - name: "Set User Age to Null"
    request:
      url: "{BASE_URL}/users/me"
      method: PUT
      headers:
        Authorization: "Bearer {user_token}"
      json:
        fullName: "Null Age Tester"
        age: null
        region: "US"
        gender: MALE
        maritalStatus: SINGLE
    response:
      status_code: 200
      json:
        fullName: "Null Age Tester"
        # age is omitted if null

  - name: "Create Rule: Null Age Check"
    request:
      url: "{BASE_URL}/fraud-rules"
      method: POST
      headers:
        Authorization: "Bearer {admin_token}"
      json:
        name: "Null Age Check {generate_random_email}"
        dslExpression: "user.age < 21"
        priority: 1
        enabled: true
    response:
      status_code: 201
      save:
        json:
          rule_null_id: id

  - name: "Create Rule: String Case Check"
    request:
      url: "{BASE_URL}/fraud-rules"
      method: POST
      headers:
        Authorization: "Bearer {admin_token}"
      json:
        name: "String Case Check {generate_random_email}"
        dslExpression: "currency = 'rub'"
        priority: 2
        enabled: true
    response:
      status_code: 201
      save:
        json:
          rule_case_id: id

  - name: "Create Rule: Precedence Check"
    request:
      url: "{BASE_URL}/fraud-rules"
      method: POST
      headers:
        Authorization: "Bearer {admin_token}"
      json:
        name: "Precedence Check {generate_random_email}"
        dslExpression: "amount > 100 OR amount < 10 AND currency = 'USD'"
        priority: 3
        enabled: true
    response:
      status_code: 201
      save:
        json:
          rule_prec_id: id

  - name: "Create Transaction"
    request:
      url: "{BASE_URL}/transactions"
      method: POST
      headers:
        Authorization: "Bearer {user_token}"
      json:
        userId: "{user_id}"
        amount: 200.00
        currency: "RUB"
        timestamp: "2026-01-20T10:00:00Z"
    response:
      status_code: 201
      json:
        ruleResults:
          - ruleId: "{rule_null_id}"
            matched: false # Null should return false
          - ruleId: "{rule_case_id}"
            matched: false # 'rub' != 'RUB'
          - ruleId: "{rule_prec_id}"
            matched: true # AND > OR, so True OR (...) = True
