test_name: User Edge Cases

marks:
  - usefixtures:
      - admin_token
      - generate_random_email

stages:
  - name: "Register Victim User"
    request:
      url: "{BASE_URL}/auth/register"
      method: POST
      json:
        email: "{generate_random_email}"
        password: "Password123!"
        fullName: "Deactivation Victim"
        age: 20
        region: "US"
        gender: MALE
        maritalStatus: SINGLE
    response:
      status_code: 201
      save:
        json:
          victim_id: user.id
          victim_token: accessToken

  - name: "Admin Deactivate Victim"
    request:
      url: "{BASE_URL}/users/{victim_id}"
      method: DELETE
      headers:
        Authorization: "Bearer {admin_token}"
    response:
      status_code: 204

  - name: "Victim Login (Deactivated)"
    request:
      url: "{BASE_URL}/auth/login"
      method: POST
      json:
        email: "{generate_random_email}"
        password: "Password123!"
    response:
      status_code: 423

  - name: "Victim Create Transaction (Deactivated)"
    request:
      url: "{BASE_URL}/transactions"
      method: POST
      headers:
        Authorization: "Bearer {victim_token}"
      json:
        userId: "{victim_id}"
        amount: 100.00
        currency: "RUB"
        timestamp: "2026-01-20T10:00:00Z"
    response:
      status_code: 403

  - name: "Register Email Changer"
    request:
      url: "{BASE_URL}/auth/register"
      method: POST
      json:
        email: "changer_{generate_random_email}"
        password: "Password123!"
        fullName: "Email Changer"
        age: 20
        region: "US"
        gender: MALE
        maritalStatus: SINGLE
    response:
      status_code: 201
      save:
        json:
          changer_token: accessToken
          original_email: user.email

  - name: "Update Profile with New Email (Ignored)"
    request:
      url: "{BASE_URL}/users/me"
      method: PUT
      headers:
        Authorization: "Bearer {changer_token}"
      json:
        fullName: "Email Changer Updated"
        email: "new_email@example.com"
        age: 20
        region: "US"
        gender: MALE
        maritalStatus: SINGLE
    response:
      status_code: 200
      json:
        email: "{original_email}"
        fullName: "Email Changer Updated"
