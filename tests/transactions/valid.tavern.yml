test_name: Transactions Valid Scenarios

marks:
  - usefixtures:
      - user_token
      - user_id
      - admin_token
      - generate_random_email
      - recent_timestamp
      - other_user_id

stages:
  - name: "Create Approved Transaction"
    request:
      url: "{BASE_URL}/transactions"
      method: POST
      headers:
        Authorization: "Bearer {user_token}"
      json:
        userId: "{user_id}"
        amount: 100.00
        currency: "RUB"
        timestamp: "{recent_timestamp}"
    response:
      status_code: 201
      json:
        transaction:
          status: APPROVED
      save:
        json:
          tx_id: transaction.id

  - name: "Get Transaction"
    request:
      url: "{BASE_URL}/transactions/{tx_id}"
      method: GET
      headers:
        Authorization: "Bearer {user_token}"
    response:
      status_code: 200
      json:
        transaction:
          id: "{tx_id}"

  - name: "Rounding Check"
    request:
      url: "{BASE_URL}/transactions"
      method: POST
      headers:
        Authorization: "Bearer {user_token}"
      json:
        userId: "{user_id}"
        amount: 10.125
        currency: "RUB"
        timestamp: "{recent_timestamp}"
    response:
      status_code: 201
      json:
        transaction:
          amount: 10.13

  - name: "Extra Fields Ignored"
    request:
      url: "{BASE_URL}/transactions"
      method: POST
      headers:
        Authorization: "Bearer {user_token}"
      json:
        userId: "{user_id}"
        amount: 10.00
        currency: "RUB"
        timestamp: "{recent_timestamp}"
        extra: "field"
    response:
      status_code: 201

  - name: "UserId Ignored for USER"
    request:
      url: "{BASE_URL}/transactions"
      method: POST
      headers:
        Authorization: "Bearer {user_token}"
      json:
        userId: "{other_user_id}"
        amount: 10.00
        currency: "RUB"
        timestamp: "{recent_timestamp}"
    response:
      status_code: 201
      json:
        transaction:
          userId: "{user_id}"

  - name: "DSL Logic Check (Setup Rule)"
    request:
      url: "{BASE_URL}/fraud-rules"
      method: POST
      headers:
        Authorization: "Bearer {admin_token}"
      json:
        name: "Test Rule {generate_random_email}"
        dslExpression: "amount > 1000"
        priority: 1
    response:
      status_code: 201
      save:
        json:
          rule_id: id

  - name: "Create Declined Transaction (DSL Match)"
    request:
      url: "{BASE_URL}/transactions"
      method: POST
      headers:
        Authorization: "Bearer {user_token}"
      json:
        userId: "{user_id}"
        amount: 2000.00
        currency: "RUB"
        timestamp: "{recent_timestamp}"
    response:
      status_code: 201
      json:
        transaction:
          status: DECLINED
        ruleResults:
          - ruleId: "{rule_id}"
            matched: true

  - name: "List Transactions (Count)"
    request:
      url: "{BASE_URL}/transactions"
      method: GET
      headers:
        Authorization: "Bearer {user_token}"
    response:
      status_code: 200
      json:
        total: 5 # 5 transactions created above
